<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org"></script>
    <script>

        fetch("/get-ip")
            .then(response => response.json())
            .then(data => {
                userIP = data.ip;
            });
        function checkSession() {
            fetch('/session')
                .then(response => response.json())
                .then(data => {
                    if (data.username) {
                        currentUser = data.username; // Store the username in the variable
                        document.getElementById('sessionInfo').innerText = `Session: ${currentUser}`;
                        console.log(currentUser);
                    }
                });
        }
        const ws = new WebSocket("ws://169.254.13.189:8080/ws");
        const cursors = {};

        ws.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);

                if (data.type === 'message') {
                    // Append the message with the username who sent it
                    appendMessage(data.text, data.user || 'Anonymous');
                    console.log(data.text);
                    console.log(data.user);
                } else if (data.type === 'cursor') {
                    cursors[data.ip] = { x: data.x, y: data.y };
                    renderCursors();
                } else if (data.type === 'disconnected') {
                    delete cursors[data.ip];
                    renderCursors();
                }
            } catch (error) {
                console.error("Error parsing message:", error);
            }
        };

        function appendMessage(message, user) {
            const chat = document.getElementById('chat');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('p-2', 'border-b'); // Add some styling for messages
            messageDiv.textContent = `${user}: ${message}`; // Display user with message
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight; // Scroll to the bottom of the chat
        }

        function sendMessage() {
            const input = document.getElementById("message");
            const message = input.value;

            if (!message) return; // Avoid sending empty messages
            
            const messageObject = {
                type: 'message',
                text: message,
                user: currentUser // Ensure the current username is passed
            };

            ws.send(JSON.stringify(messageObject)); // Send message with user details
            input.value = ''; // Clear the input field
        }



        function sendCursorPosition(event) {
            const rect = document.body.getBoundingClientRect();
            let x = event.clientX - rect.left + window.scrollX;
            let y = event.clientY - rect.top + window.scrollY;

            x = Math.max(0, Math.min(window.innerWidth - 10, x));
            y = Math.max(0, Math.min(window.innerHeight - 10, y));

            ws.send(JSON.stringify({ type: 'cursor', x: x, y: y, ip: userIP }));
        }


        function renderCursors() {
            const cursorsDiv = document.getElementById("cursors");
            cursorsDiv.innerHTML = '';

            for (const [ip, pos] of Object.entries(cursors)) {
                if (ip === userIP) continue;

                let cursorPixel = document.getElementById(`cursor-${ip}`);

                if (!cursorPixel) {
                    cursorPixel = document.createElement('div');
                    cursorPixel.id = `cursor-${ip}`;
                    cursorPixel.style.position = 'absolute';
                    cursorPixel.style.width = '10px';
                    cursorPixel.style.height = '10px';
                    cursorPixel.style.borderRadius = '100px';
                    cursorPixel.style.backgroundColor = 'red';
                    cursorPixel.style.transition = 'left 0.1s ease, top 0.1s ease';
                    cursorPixel.title = ip;
                    cursorsDiv.appendChild(cursorPixel);
                }

                cursorPixel.style.left = `${pos.x}px`;
                cursorPixel.style.top = `${pos.y}px`;
            }
        }

        window.onload = function () {
            checkSession();
        };

        document.addEventListener('mousemove', sendCursorPosition);
    </script>

</head>

<body class="bg-gray-100">
    <nav class="p-4 bg-blue-500 text-white flex justify-between items-center">
        <a href="/nav-content" hx-get="/nav-content" hx-target="this" class="hover:underline">Load Nav</a>
        <div>
            <button id="loginButton" class="bg-blue-700 hover:bg-blue-600 text-white px-4 py-2 rounded mr-2"
                onclick="showLoginForm()">Login</button>
            <button id="registerButton" class="bg-blue-700 hover:bg-blue-600 text-white px-4 py-2 rounded"
                onclick="showRegisterForm()">Register</button>
        </div>
    </nav>
    <div id="sidepanel" class="p-4 bg-gray-200" hx-get="/side-content" hx-trigger="load">
        Loading sidepanel...
    </div>

    <div id="content" class="p-4" hx-get="/main-content" hx-trigger="load">
        Loading content...
    </div>

    <button id="chatButton"
        class="fixed right-0 top-1/2 transform -translate-y-1/2 bg-blue-500 text-white p-2 rounded-l-md">
        Chat
    </button>

    <div id="chatContainer" class="fixed right-0 top-0 h-full w-72 bg-white border-l shadow-lg hidden">
        <div class="p-2 bg-blue-500 text-white flex items-center justify-between">
            <span>Chat</span>
            <button id="closeChatButton" class="bg-transparent text-white ml-2" onclick="toggleChat()">✖</button>
        </div>
        <div id="chat" class="p-4 bg-white border rounded h-3/4 overflow-y-auto"></div>
        <div class="p-2 border-t">
            <input type="text" id="message" class="border p-2 w-full" placeholder="Type a message...">
            <button onclick="sendMessage()" class="bg-blue-500 text-white p-2 mt-2 w-full">Send</button>
        </div>
    </div>
    <div id="authContainer"
        class="fixed top-0 left-0 w-full h-full bg-gray-800 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded shadow-md">
            <div class="p-2 bg-blue-500 text-white flex items-center justify-between">
                <h2 class="text-xl" id="authTitle">Login</h2>
                <button id="switchToRegister" class="bg-transparent text-white ml-2"
                    onclick="toggleAuthForm()">✖</button>
            </div>
            <div id="authMessage" class="text-red-500 mb-4"></div>
            <input type="text" id="authUsername" class="border p-2 w-full mb-2" placeholder="Username">
            <input type="password" id="authPassword" class="border p-2 w-full mb-2" placeholder="Password">
            <button id="authSubmit" class="bg-blue-500 text-white p-2 w-full">Login</button>
        </div>
    </div>
    <div id="sessionInfo" class="p-4 bg-green-200 text-green-800">

    </div>

    <div id="cursors" class="absolute pointer-events-none"></div> <!-- To display cursors -->

</body>

<style>
    body {
        margin: 0;
        padding: 0;
        height: 100vh;
    }

    #cursors {
        left: 0;
        top: 0;
    }

    #chat {
        max-height: 100%;
        overflow-y: auto;
    }

    #chatContainer {
        width: 300px;
    }

    #chatButton {
        cursor: pointer;
    }
</style>
<script>
    function showLoginForm() {
        document.getElementById('authTitle').innerText = 'Login';
        document.getElementById('authSubmit').innerText = 'Login';
        document.getElementById('switchToRegister').innerText = '✖';
        document.getElementById('authContainer').classList.remove('hidden');
    }

    function showRegisterForm() {
        document.getElementById('authTitle').innerText = 'Register';
        document.getElementById('authSubmit').innerText = 'Register';
        document.getElementById('switchToRegister').innerText = '✖';
        document.getElementById('authContainer').classList.remove('hidden');
    }

    function toggleAuthForm() {
        const authContainer = document.getElementById('authContainer');
        authContainer.classList.toggle('hidden');
    }

    document.getElementById('authSubmit').addEventListener('click', function () {
        const username = document.getElementById('authUsername').value;
        const password = document.getElementById('authPassword').value;
        const isLogin = document.getElementById('authTitle').innerText === 'Login';

        const url = isLogin ? '/login' : '/register';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password })
        }).then(response => {
            if (response.ok) {
                document.getElementById('authMessage').innerText = 'Success!';
                toggleAuthForm();
            } else {
                return response.json().then(data => {
                    document.getElementById('authMessage').innerText = data.message;
                });
            }
        });
    });
</script>
<script>
    function toggleChat() {
        const chatContainer = document.getElementById('chatContainer');
        const chatButton = document.getElementById('chatButton');

        if (chatContainer.classList.contains('hidden')) {
            chatContainer.classList.remove('hidden');
            chatButton.textContent = 'Close Chat'; // Update button text
        } else {
            chatContainer.classList.add('hidden');
            chatButton.textContent = 'Chat'; // Update button text
        }
    }

    // Update chat button to use the new toggleChat function
    document.getElementById('chatButton').addEventListener('click', toggleChat);


    document.getElementById("message").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            event.preventDefault(); // Prevent form submission (if any)
            sendMessage(); // Call sendMessage function
        }
    });
</script>

</html>